---
title: "Preprocessing"
output:
  html_document: default
  pdf_document: default
---

## 1. Lectura de les dades

```{r include=FALSE}
#datos <- read.csv("data/train.csv")
#datos <- read.csv("train.csv")
datos <- read.csv("~/CARRERA/4to/Minería de Dades/predicci-MeMdA/data/train.csv")
```


Mirem la tipología preestablerta de les diferents variables:

```{r echo=FALSE}
(clases = sapply(datos, class))
```
Canviem a la tipología correcta les diferents variables o les eliminem:

```{r}
datos$NumOfProducts <- as.factor(datos$NumOfProducts)
datos$HasCrCard <- as.factor(datos$HasCrCard)
datos$IsActiveMember <- as.factor(datos$IsActiveMember)
datos$SavingsAccountFlag <- as.factor(datos$SavingsAccountFlag)
datos$LoanStatus <- as.factor(datos$LoanStatus)
datos$Gender <- as.factor(datos$Gender)
datos$EducationLevel <- as.factor(datos$EducationLevel)
datos$Geography <- as.factor(datos$Geography)
datos$ComplaintsCount <- as.factor(datos$ComplaintsCount)
datos$CustomerSegment <- as.factor(datos$CustomerSegment)
datos$MaritalStatus <- as.factor(datos$MaritalStatus)
datos$Exited <- as.factor(datos$Exited)
datos <- datos[,-1] #Eliminem la columna "X"
(clases = sapply(datos, class))
```
Classifiquem les variables en dos grups per l'anàlisi exploratori univariant i bivariant:
```{r echo=FALSE}
(varNum <- names(clases)[which(clases %in% c("numeric", "integer"))])
```
```{r echo=FALSE}
(varCat <- names(clases)[which(clases %in% c("character", "factor"))])
```

## 2.1 Anàlisi Exploratori Univariant


### 2.1.1 Variables Numèriques


Aïllem les variables numèriques que realment són inútils per fer l'anàlisi exploratiu:
```{r echo=FALSE}
(varNum2 <- varNum[-8])
```

#### 2.1.1.1 Taula:

```{r echo=FALSE}
library(psych)
psych::describe(datos[, varNum2])
```


#### 2.1.1.2  Gràfics

```{r echo=FALSE}
# ===== Gráficos variables numéricas (optimizado) =====

vars_num <- varNum2   # vector de variables numéricas

# Guardar configuración original de gráficos
old_par <- par(no.readonly = TRUE)
on.exit(par(old_par), add = TRUE)

# Configuración general
par(mfrow = c(2, 2), mar = c(4, 4, 3, 1))

for (var in vars_num) {
  x <- datos[[var]]
  x <- x[is.finite(x)]
  n <- length(x)

  if (n == 0) next  # saltar si todo NA

  # Cálculos básicos una sola vez
  mu <- mean(x)
  s <- stats::sd(x)
  nb <- tryCatch(nclass.FD(x), error = function(e) 30)

  ## --- HISTOGRAMA + DENSIDADES ---
  h <- hist(x, breaks = nb, plot = FALSE)
  y_lim <- c(0, max(h$counts) * 1.2)

  plot(h, col = "#90CAF9", border = "white",
       main = paste("Histograma variable", var),
       xlab = var, ylab = "Frecuencia", ylim = y_lim)

  # Añadir densidad y curva normal
  den <- density(x, adjust = 1)
  scale_factor <- diff(h$mids[1:2]) * n
  lines(den$x, den$y * scale_factor, lwd = 2, col = "#1565C0")
  lines(h$mids,
        dnorm(h$mids, mean = mu, sd = s) * scale_factor,
        lwd = 2, lty = 2, col = "#FF7043")

  rug(x, col = "#455A6455")
  legend("topright",
         legend = c("Densidad", "Normal(μ,σ)"),
         col = c("#1565C0", "#FF7043"),
         lwd = 2, lty = c(1, 2), bty = "n", cex = 0.8)

  ## --- BOXLOT PROFESIONAL ---
  bx_range <- range(x, na.rm = TRUE)
  plot.new()
  plot.window(xlim = bx_range, ylim = c(0.5, 1.5))
  abline(v = pretty(bx_range, 6), col = "#ECEFF1", lwd = 1)

  boxplot(x, horizontal = TRUE, add = TRUE, at = 1,
          col = "#A5D6A7", border = "#2E7D32",
          notch = TRUE, outline = TRUE,
          pch = 16, cex = 0.6, axes = FALSE, frame = FALSE)

  points(mu, 1, pch = 23, cex = 1.1, bg = "#FF7043", col = "white")
  axis(1)
  title(main = paste("Boxplot variable", var), xlab = var, cex.main = 1)

  legend("topleft",
         legend = c("Mediana", "Media"),
         pch = c(15, 23), pt.cex = c(1.2, 1.1),
         col = c("#2E7D32", "#FF7043"),
         bty = "n", cex = 0.8)
}
```

### 2.1.2 Variables Categòriques

Aïllem les variables numèriques que realment són inútils per fer l'anàlisi exploratiu:
```{r echo=FALSE}
(varCat2 <- varCat[-4])
```

#### 2.1.2.1 Taules:

```{r}
for (var in varCat2) {
  tablaAbs <- data.frame(table(datos[, var]))
  tablaFreq <- data.frame(table(datos[, var])/sum(table(datos[, var])))
  m <- match(tablaAbs$Var1, tablaFreq$Var1)
  tablaAbs[, "FreqRel"] <- tablaFreq[m, "Freq"]
  colnames(tablaAbs) <- c("Categoria", "FreqAbs", "FreqRel")
  
  cat("===============", var, "===================================\n")
  print(tablaAbs)
  cat("==================================================\n")
}
```

#### 2.1.2.2 Gràfics

<br>
<br>
<br>

```{r}
library(ggplot2)
library(gridExtra)

plots <- list()   # lista vacía
i <- 1            # índice

for (var in varCat2) {
  tabla <- data.frame(table(datos[, var]) / sum(table(datos[, var])))

  p <- ggplot(data = tabla, aes(x = Var1, y = Freq)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    geom_text(aes(label = paste0(round(Freq * 100, 2), "%")),
              vjust = 1.6, color = "white", size = 3.5) +
    theme_minimal() +
    labs(title = paste("Dist.", var),
         x = var,
         y = "Proporción")

  plots[[i]] <- p
  i <- i + 1
}

# Mostrar todos los gráficos en un grid (ejemplo con 3 columnas)
grid.arrange(grobs = plots, ncol = 3)
```

## 2.2 Anàlisi Bivariant


### 2.2.1 Numèriques vs Numèriques 


#### 2.2.1.1 Taula de correlacions

```{r}
cor(datos[, varNum2], use="complete.obs")
```

```{r}
install.packages("ggcorrplot")
library(ggcorrplot)
corr <- round(cor(datos[, varNum2], use="complete.obs"), 1)
ggcorrplot(corr, lab = T)
```

### 2.2.2 Numèriques vs Categòriques


#### 2.2.2.1 Resum per categoríes

```{r}
for (varN in varNum2) {
  for (varC in varCat2) {
   print(psych::describeBy(datos[, varN], group = datos[, varC])) 
  }
}
```


#### 2.2.2.2 Gràfic 
```{r}
library(ggplot2)
library(gridExtra)

plots <- list()
i <- 1

for (varC in varCat2) {
  for (varN in varNum2) {
    
    grafico <- ggplot(datos, aes(x = .data[[varN]], fill = .data[[varC]])) + 
      geom_histogram(colour = "black",
                     lwd = 0.75,
                     linetype = 1,
                     position = "identity",
                     alpha = 0.5) +
      labs(title = paste("Histograma de", varN, "por", varC),
           x = varN, y = "Frecuencia", fill = varC) +
      theme_minimal()
    
    plots[[i]] <- grafico
    i <- i + 1
  }
}

# Mostrar todos en un grid (2 columnas)
grid.arrange(grobs = plots,ncol=2)
```


### 2.2.3 Categorical vs. categorical

#### 2.2.3.1 Taules

```{r}
for (varc1 in varCat2) {
  for (varc2 in varCat2) {
    if (varc1 != varc2) {
      prop_table <- prop.table(table(datos[, varc1], datos[, varc2]))
      cat("=============", varc1, " vs. ", varc2, "=========================\n")
      print(prop_table)
    }
  }
}
```

#### 2.2.3.2 Gràfics

```{r}
par(mfrow = c(3, 3))  
for (varc1 in varCat2) {
  for (varc2 in varCat2) {
    if (varc1 != varc2) {
      prop_table <- prop.table(table(datos[, varc1], datos[, varc2]))
      barplot(prop_table, beside = TRUE, col=rainbow(4))
    }
  }
}
```

