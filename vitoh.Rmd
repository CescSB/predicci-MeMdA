---
title: "vitoh"
output: html_document
---
## 1. Lectura de les dades:

```{r}
datos <- read.csv("data/train.csv")
```


Mirem la tipología preestablerta de les diferents variables:

```{r}
(clases = sapply(datos, class))
```
<br>

Canviem a la tipología correcta les diferents variables o les eliminem:

```{r}
datos$NumOfProducts <- as.factor(datos$NumOfProducts)
datos$HasCrCard <- as.factor(datos$HasCrCard)
datos$IsActiveMember <- as.factor(datos$IsActiveMember)
datos$SavingsAccountFlag <- as.factor(datos$SavingsAccountFlag)
datos$LoanStatus <- as.factor(datos$LoanStatus)
datos$Gender <- as.factor(datos$Gender)
datos$EducationLevel <- as.factor(datos$EducationLevel)
datos$Geography <- as.factor(datos$Geography)
datos$ComplaintsCount <- as.factor(datos$ComplaintsCount)
datos$CustomerSegment <- as.factor(datos$CustomerSegment)
datos$MaritalStatus <- as.factor(datos$MaritalStatus)
datos$Exited <- as.factor(datos$Exited)
datos <- datos[,-1] #Eliminem la columna "X"
(clases = sapply(datos, class))
```

<br>

Classifiquem les variables en dos grups per l'anàlisi exploratori univariant i bivariant:
```{r}
(varNum <- names(clases)[which(clases %in% c("numeric", "integer"))])
```


```{r}
(varCat <- names(clases)[which(clases %in% c("character", "factor"))])
```
<br>


## 2.1 Anàlisi Exploratori Univariant

### 2.1.1 Variables Numèriques:


Aïllem les variables numèriques que realment són inútils per fer l'anàlisi exploratiu:
```{r}
(varNum2 <- varNum[-8])
```


#### 2.1.1.1 Taula:

```{r}
library(psych)
psych::describe(datos[, varNum])
```


#### 2.1.1.2  Gràfics:

```{r}
# vars numéricas
vars_num <- varNum  # o el vector que uses

old_par <- par(no.readonly = TRUE)
on.exit(par(old_par), add = TRUE)

par(mfrow = c(2, 2), mar = c(4, 4, 3, 1), oma = c(0, 0, 0, 0))

for (var in vars_num) {
  x <- datos[[var]]
  x <- x[is.finite(x)]

  ## --- Histograma con líneas de distribución ---
  # breaks tipo Freedman–Diaconis
  nb <- tryCatch(nclass.FD(x), error = function(e) 30)
  h <- hist(x,
            breaks = nb, col = "#90CAF9", border = "white",
            main = paste("Histograma variable", var),
            xlab = var, ylab = "Frecuencia")

  # Densidad (re-escalada a cuentas del histograma)
  den <- density(x)
  # escalar densidad a la escala del histograma (cuentas)
  y_den <- den$y * diff(h$mids[1:2]) * length(x)
  lines(den$x, y_den, lwd = 2)                 # línea de densidad

  # Curva normal ajustada (μ, σ de los datos), también en escala de cuentas
  mu <- mean(x); s <- stats::sd(x)
  y_norm <- dnorm(h$mids, mean = mu, sd = s) * diff(h$mids[1:2]) * length(x)
  lines(h$mids, y_norm, lwd = 2, lty = 2)      # línea normal (discontinua)

  rug(x, col = "#455A6455")                    # rug para ver acumulaciones

  legend("topright",
         legend = c("Densidad", "Normal(μ,σ)"),
         lwd = 2, lty = c(1, 2), bty = "n")

  ## --- Boxplot “profesional” ---
  # grid sutil
  bx_range <- range(x, na.rm = TRUE)
  plot.new()
  plot.window(xlim = bx_range, ylim = c(0.5, 1.5))
  abline(v = pretty(bx_range, 6), col = "#ECEFF1", lwd = 1)

  boxplot(x,
          horizontal = TRUE, add = TRUE, at = 1,
          col = "#A5D6A7", border = "#2E7D32",
          notch = TRUE,  # muesca para IC de la mediana
          outline = TRUE, pch = 16, cex = 0.6,  # outliers discretos
          axes = FALSE, frame = FALSE)

  # Media destacada
  points(mu, 1, pch = 23, cex = 1.1, bg = "#FF7043", col = "white")

  axis(1)
  title(main = paste("Boxplot variable", var), xlab = var)
  legend("topleft",
         legend = c("Mediana (caja)", "Media"),
         pch = c(15, 23), pt.cex = c(1.2, 1.1),
         col = c("#2E7D32", "#FF7043"), bty = "n")
}

```


### 2.1.2 Variables Categòriques:


Aïllem les variables numèriques que realment són inútils per fer l'anàlisi exploratiu:
```{r}
(varCat2 <- varCat[-4])
```

#### 2.1.2.1 Taules:

```{r}
for (var in varCat) {
  tablaAbs <- data.frame(table(datos[, var]))
  tablaFreq <- data.frame(table(datos[, var])/sum(table(datos[, var])))
  m <- match(tablaAbs$Var1, tablaFreq$Var1)
  tablaAbs[, "FreqRel"] <- tablaFreq[m, "Freq"]
  colnames(tablaAbs) <- c("Categoria", "FreqAbs", "FreqRel")
  
  cat("===============", var, "===================================\n")
  print(tablaAbs)
  cat("==================================================\n")
}
```

#### 2.1.2.2 Gràfics:

```{r}
library(ggplot2)
library(gridExtra)

plots <- list()   # lista vacía
i <- 1            # índice

for (var in varCat2) {
  tabla <- data.frame(table(datos[, var]) / sum(table(datos[, var])))

  p <- ggplot(data = tabla, aes(x = Var1, y = Freq)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    geom_text(aes(label = paste0(round(Freq * 100, 2), "%")),
              vjust = 1.6, color = "white", size = 3.5) +
    theme_minimal() +
    labs(title = paste("Dist.", var),
         x = var,
         y = "Proporción")

  plots[[i]] <- p
  i <- i + 1
}

# Mostrar todos los gráficos en un grid (ejemplo con 3 columnas)
grid.arrange(grobs = plots, ncol = 3)
```


HOLA

